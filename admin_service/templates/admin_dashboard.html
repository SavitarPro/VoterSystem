<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Election Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sidebar {
            min-height: 100vh;
            background: #2c3e50;
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
        }
        .sidebar .nav-link:hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255,255,255,0.2);
        }
        .stat-card {
            transition: transform 0.2s;
            border: none;
            border-radius: 10px;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container-fluid p-0">
        <div class="row g-0">
            <!-- Sidebar -->
            <div class="col-lg-2 sidebar p-0">
                <div class="p-4">
                    <h5 class="text-white mb-4 text-center">
                        <i class="fas fa-shield-alt me-2"></i>Election Admin
                    </h5>
                    <hr class="text-white-50">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#results">
                                <i class="fas fa-chart-bar me-2"></i> Results
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#activity">
                                <i class="fas fa-history me-2"></i> Activity
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#stats">
                                <i class="fas fa-chart-line me-2"></i> Statistics
                            </a>
                        </li>
                        <li class="nav-item mt-4">
                            <a class="nav-link text-warning" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i> Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-10 p-4" style="background: #f8f9fa;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="text-dark">Election Results Dashboard</h2>
                    <div>
                        <span class="text-muted me-3" id="lastUpdated"></span>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4" id="stats">
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card stat-card bg-primary text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-vote-yea fa-2x mb-2"></i>
                                <h4 class="card-title">{{ results.total_votes if results else 0 }}</h4>
                                <p class="card-text mb-0">Total Votes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card stat-card bg-success text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-users fa-2x mb-2"></i>
                                <h4 class="card-title">{{ turnout.turnout_percentage if turnout }}%</h4>
                                <p class="card-text mb-0">Voter Turnout</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card stat-card bg-info text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-landmark fa-2x mb-2"></i>
                                <h4 class="card-title">{{ parties|length }}</h4>
                                <p class="card-text mb-0">Political Parties</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card stat-card bg-warning text-dark">
                            <div class="card-body text-center">
                                <i class="fas fa-bolt fa-2x mb-2"></i>
                                <h4 class="card-title">{{ system_stats.active_sessions if system_stats else 0 }}</h4>
                                <p class="card-text mb-0">Active Sessions</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="row mb-4" id="results">
                    <div class="col-lg-8 mb-4">
                        <div class="chart-container">
                            <h5 class="mb-3">Election Results by Party</h5>
                            <canvas id="resultsChart" height="250"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="chart-container">
                            <h5 class="mb-3">Results Summary</h5>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Party</th>
                                            <th>Votes</th>
                                            <th>%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if results and results.party_results %}
                                            {% for party_code, votes in results.party_results %}
                                            <tr>
                                                <td>{{ parties[party_code].name if party_code in parties else 'Unknown' }}</td>
                                                <td><strong>{{ votes }}</strong></td>
                                                <td>{{ (votes / results.total_votes * 100)|round(1) if results.total_votes > 0 else 0 }}%</td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="3" class="text-center text-muted">No votes recorded yet</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeline Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="chart-container">
                            <h5 class="mb-3">Voting Activity Timeline</h5>
                            <canvas id="timelineChart" height="100"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Section -->
                <div class="row" id="activity">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Recent Voting Activity</h5>
                                <span class="badge bg-secondary">Last 15 activities</span>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Voter NIC</th>
                                            <th>Start Time</th>
                                            <th>End Time</th>
                                            <th>Duration</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if recent_activity %}
                                            {% for nic, start_time, end_time, status in recent_activity %}
                                            <tr>
                                                <td><code>{{ nic }}</code></td>
                                                <td>{{ start_time.strftime('%Y-%m-%d %H:%M') if start_time else 'N/A' }}</td>
                                                <td>{{ end_time.strftime('%Y-%m-%d %H:%M') if end_time else 'N/A' }}</td>
                                                <td>
                                                    {% if start_time and end_time %}
                                                        {{ (end_time - start_time).seconds // 60 }} min
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ 'success' if status == 'completed' else 'warning' if status == 'active' else 'secondary' }}">
                                                        {{ status|title }}
                                                    </span>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">No recent activity</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Update last updated time
        function updateLastUpdated() {
            document.getElementById('lastUpdated').textContent =
                'Last updated: ' + new Date().toLocaleString();
        }
        updateLastUpdated();

        // Initialize charts
        async function initializeCharts() {
            try {
                // Results Chart
                const resultsResponse = await fetch('/api/results');
                if (!resultsResponse.ok) throw new Error('Failed to fetch results');

                const resultsData = await resultsResponse.json();

                if (resultsData.party_results && resultsData.party_results.length > 0) {
                    const resultsCtx = document.getElementById('resultsChart').getContext('2d');
                    new Chart(resultsCtx, {
                        type: 'bar',
                        data: {
                            labels: resultsData.party_results.map(p => p.party_name),
                            datasets: [{
                                label: 'Votes',
                                data: resultsData.party_results.map(p => p.vote_count),
                                backgroundColor: resultsData.party_results.map(p => {
                                    const party = {{ parties|tojson }};
                                    return party[p.party_code]?.color || '#6c757d';
                                }),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false },
                                title: { display: true, text: 'Votes by Party', font: { size: 16 } }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Number of Votes' }
                                }
                            }
                        }
                    });
                }

                // Timeline Chart
                const timelineResponse = await fetch('/api/timeline');
                if (timelineResponse.ok) {
                    const timelineData = await timelineResponse.json();

                    if (timelineData.length > 0) {
                        const timelineCtx = document.getElementById('timelineChart').getContext('2d');
                        new Chart(timelineCtx, {
                            type: 'line',
                            data: {
                                labels: timelineData.map(d => d.hour),
                                datasets: [{
                                    label: 'Votes per Hour',
                                    data: timelineData.map(d => d.votes),
                                    borderColor: '#007bff',
                                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    title: { display: true, text: 'Voting Activity Timeline', font: { size: 16 } }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: { display: true, text: 'Votes' }
                                    }
                                }
                            }
                        });
                    }
                }

            } catch (error) {
                console.error('Error initializing charts:', error);
            }
        }

        // Refresh data
        function refreshData() {
            window.location.reload();
        }

        // Logout function
        async function logout() {
            try {
                const response = await fetch('/logout');
                const data = await response.json();
                if (data.success) {
                    window.location.href = data.redirect;
                }
            } catch (error) {
                alert('Logout failed: ' + error);
            }
        }

        // Auto-refresh every 2 minutes
        setInterval(refreshData, 120000);

        // Initialize charts on page load
        document.addEventListener('DOMContentLoaded', initializeCharts);
    </script>
</body>
</html>