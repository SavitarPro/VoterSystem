<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Camera Monitoring</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .video-feed {
            width: 100%;
            max-width: 640px;
            border: 3px solid #007bff;
            border-radius: 10px;
        }
        .camera-card {
            cursor: pointer;
            transition: all 0.3s;
        }
        .camera-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-video me-2"></i>Test Camera Monitoring
            </span>
            <a href="/" class="btn btn-outline-light">
                <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5>Available Cameras</h5>
                    </div>
                    <div class="card-body">
                        <div id="cameraList" class="list-group">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Scanning for cameras...</p>
                            </div>
                        </div>

                        <div class="mt-3">
                            <label class="form-label">Test Voter NIC</label>
                            <input type="text" class="form-control" id="testVoterNIC" value="TEST123456789">
                        </div>

                        <div class="mt-3 d-grid">
                            <button id="startMonitoring" class="btn btn-success" disabled>
                                <i class="fas fa-play me-1"></i> Start Monitoring
                            </button>
                            <button id="stopMonitoring" class="btn btn-danger mt-2" disabled>
                                <i class="fas fa-stop me-1"></i> Stop Monitoring
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header bg-warning">
                        <h5>Detection Results</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center">
                            <div class="display-4" id="personCount">0</div>
                            <div class="text-muted">Persons Detected</div>
                        </div>

                        <div class="mt-3">
                            <div id="detectionStatus" class="alert alert-info">
                                Monitoring not started
                            </div>
                        </div>

                        <div class="mt-3">
                            <h6>Camera Information:</h6>
                            <div id="cameraInfo" class="small text-muted">
                                No camera active
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5>Live Video Feed</h5>
                    </div>
                    <div class="card-body text-center">
                        <img id="videoFeed" class="video-feed"
                             src="https://via.placeholder.com/640x360/6c757d/ffffff?text=Select+a+camera+to+start"
                             alt="Live video feed">
                        <div class="mt-2">
                            <span class="badge bg-secondary" id="connectionStatus">
                                Disconnected
                            </span>
                            <span class="badge bg-info ms-2" id="fpsCounter">
                                0 FPS
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    let selectedCameraIndex = null;
    let currentVoterNIC = 'TEST123456789';
    let monitoringInterval = null;
    let frameCount = 0;
    let fpsInterval = null;

    async function loadCameras() {
        try {
            const response = await fetch('/api/test/available_cameras');
            const data = await response.json();

            const cameraList = document.getElementById('cameraList');
            cameraList.innerHTML = '';

            if (data.cameras && data.cameras.length > 0) {
                data.cameras.forEach(camera => {
                    const cameraElement = document.createElement('button');
                    cameraElement.className = 'list-group-item list-group-item-action camera-card';
                    cameraElement.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <strong>${camera.name}</strong>
                            <span class="badge bg-info">${camera.resolution}</span>
                        </div>
                        <small class="text-muted">Index: ${camera.index}</small>
                    `;

                    cameraElement.addEventListener('click', () => {
                        document.querySelectorAll('.camera-card').forEach(btn => {
                            btn.classList.remove('active');
                        });

                        cameraElement.classList.add('active');

                        document.getElementById('startMonitoring').disabled = false;

                        selectedCameraIndex = camera.index;
                    });

                    cameraList.appendChild(cameraElement);
                });
            } else {
                cameraList.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No cameras found. Make sure your camera is connected.
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading cameras:', error);
            document.getElementById('cameraList').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error loading cameras: ${error.message}
                </div>
            `;
        }
    }

    async function startMonitoring() {
        currentVoterNIC = document.getElementById('testVoterNIC').value || 'TEST123456789';

        try {
            const response = await fetch('/api/test/start_monitoring', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    voter_nic: currentVoterNIC,
                    camera_index: selectedCameraIndex
                })
            });

            const result = await response.json();

            if (result.success) {
                document.getElementById('startMonitoring').disabled = true;
                document.getElementById('stopMonitoring').disabled = false;
                document.getElementById('connectionStatus').className = 'badge bg-success';
                document.getElementById('connectionStatus').textContent = 'Connected';

                startMonitoringLoop();

                startFpsCounter();
            } else {
                alert('Error: ' + (result.error || 'Failed to start monitoring'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function stopMonitoring() {
        try {
            const response = await fetch('/api/test/stop_monitoring', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    voter_nic: currentVoterNIC
                })
            });

            stopMonitoringLoop();

            document.getElementById('startMonitoring').disabled = false;
            document.getElementById('stopMonitoring').disabled = true;
            document.getElementById('connectionStatus').className = 'badge bg-secondary';
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('videoFeed').src =
                'https://via.placeholder.com/640x360/6c757d/ffffff?text=Monitoring+stopped';

        } catch (error) {
            console.error('Error stopping monitoring:', error);
        }
    }

    function startMonitoringLoop() {
        monitoringInterval = setInterval(async () => {
            try {
                const response = await fetch('/api/active_monitoring');
                const data = await response.json();

                if (data.current_voter) {
                    if (data.current_voter.last_frame) {
                        document.getElementById('videoFeed').src = data.current_voter.last_frame;
                    }

                    if (data.current_voter.last_detection) {
                        const count = data.current_voter.last_detection.person_count;
                        document.getElementById('personCount').textContent = count;

                        const statusDiv = document.getElementById('detectionStatus');
                        if (count >= 2) {
                            statusDiv.className = 'alert alert-danger';
                            statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>FRAUD DETECTED: ${count} persons`;
                        } else {
                            statusDiv.className = 'alert alert-success';
                            statusDiv.innerHTML = `<i class="fas fa-check-circle me-2"></i>Normal: ${count} person detected`;
                        }
                    }

                    const cameraInfo = document.getElementById('cameraInfo');
                    cameraInfo.innerHTML = `
                        <strong>Camera:</strong> ${selectedCameraIndex}<br>
                        <strong>Voter NIC:</strong> ${currentVoterNIC}<br>
                        <strong>Status:</strong> <span class="badge bg-success">Active</span>
                    `;
                }

                frameCount++;

            } catch (error) {
                console.error('Error in monitoring loop:', error);
            }
        }, 1000);
    }

    function stopMonitoringLoop() {
        if (monitoringInterval) {
            clearInterval(monitoringInterval);
            monitoringInterval = null;
        }
        if (fpsInterval) {
            clearInterval(fpsInterval);
            fpsInterval = null;
        }
        document.getElementById('fpsCounter').textContent = '0 FPS';
        frameCount = 0;
    }

    function startFpsCounter() {
        if (fpsInterval) clearInterval(fpsInterval);

        fpsInterval = setInterval(() => {
            document.getElementById('fpsCounter').textContent = `${frameCount} FPS`;
            frameCount = 0;
        }, 1000);
    }

    document.getElementById('startMonitoring').addEventListener('click', startMonitoring);
    document.getElementById('stopMonitoring').addEventListener('click', stopMonitoring);
    document.getElementById('testVoterNIC').addEventListener('input', function() {
        currentVoterNIC = this.value || 'TEST123456789';
    });

    document.addEventListener('DOMContentLoaded', loadCameras);
    </script>
</body>
</html>